package expenses_tests;

import expenses;

[Test]
class Tests

    private static operation declareFor(amount : Double, employee : Employee) : Expense;
    begin
        var cat; 
        cat := Tests#category("Sample category");
        return employee.declareExpense("just a test expense", amount, Date#today(), cat);
    end;

    private static operation declare(amount : Double) : Expense;
    begin
        return Tests#declareFor(amount, Tests#employee("John Doe"));
    end;
    
    private static operation category(name : String) : Category;
    begin
        var cat;
        cat := new Category;
        cat.name := name;
        return cat;
    end;
    
    static operation employee(name : String) : Employee;
    begin
        var employee;
        employee := new Employee;
        employee.name := name;
        employee.username := name;        
        return employee;
    end;

    operation declaredExpenseRemainsInDraft();
    begin
        var expense : Expense;
        begin
            expense := Tests#declare(10.0);
        end;
        begin
            Assert#areEqual(Expense::Status#Draft, expense.status);
        end;
    end;

    operation automaticApproval();
    begin
        var employee;
        employee := Tests#employee("Jane Doe");
        Assert#isTrue(Tests#declareFor(49.9, employee).automaticApproval);
        Assert#isTrue(not Tests#declareFor(50.0, employee).automaticApproval);
    end;

    operation submitExpenseUnder50IsAutomaticallyApproved();
    begin
        var expense : Expense;
        begin
            expense := Tests#declare(10.0);
            Assert#isTrue(expense.automaticApproval);
        end;        
        begin
            expense.submit();
        end;
        begin
            Assert#areEqual(Expense::Status#Approved, expense.status);
        end;
    end;

    operation submitExpense50AndOverNeedsApproval();
    begin
        var expense : Expense;
        begin
            expense := Tests#declare(100.0);
            Assert#isTrue(not expense.automaticApproval);
        end;
        begin
            expense.submit();
        end;
        begin
            Assert#areEqual(Expense::Status#Submitted, expense.status);
        end;
    end;
    operation rejectedExpense();
    begin
        var expense : Expense;
        begin
            expense := Tests#declare(100.0);
        end;
        begin
            expense.submit();
        end;
        begin
            expense.reject(Memo#fromString("Non-reimbursable"));
        end;
        begin
            Assert#areEqual(Expense::Status#Rejected, expense.status);
        end;
    end;    
    operation expenseByCategoryCounts();
    begin
        var employee, cat1, cat2, cat3;
        begin
            employee := Tests#employee("Jane Doe");
            cat1 := Tests#category("category 1");
            cat2 := Tests#category("category 2");
            cat3 := Tests#category("category 2");            
        end; 
        begin        
            employee.declareExpense("expense 1", 100, Date#today(), cat1).submit();
            employee.declareExpense("expense 2", 100, Date#today(), cat1).submit();
            employee.declareExpense("expense 3", 100, Date#today(), cat2).submit();
        end;
        begin
            var stats, cat1Stats;
            stats := Expense#openExpenseCountPerCategory();
            Assert#isTrue(stats.size() >= 2);
            
            cat1Stats := stats.\any(
            	(group : {category : Category, count : Integer}) : Boolean {
            		group.category == cat1 
        		}
        	);
            Assert#isNotNull(cat1Stats);
            Assert#areEqual(2, cat1Stats.count);            
        end;
    end;    
    
    operation expenseByEmployeeCounts();
    begin
        var ceo, salesGuy, programmer;
        begin
            ceo := Tests#employee("The CEO");
            salesGuy := Tests#employee("A sales guy");            
            programmer := Tests#employee("A programmer that never expenses anything");                        
        end; 
        begin        
            Tests#declareFor(800, ceo);
            Tests#declareFor(1000, ceo);            
            Tests#declareFor(2000, ceo);                        
            Tests#declareFor(500, salesGuy);            
        end;
        begin
            var stats, ceoStats, salesGuyStats;
            stats := Expense#expenseCountPerEmployee();
            Assert#isTrue(stats.size() >= 2);
            
            ceoStats := stats.\any(
            	(group : {employee : Employee, expenseCount : Integer}) : Boolean {
            		group.employee == ceo
        		}
        	);
            salesGuyStats := stats.\any(
            	(group : {employee : Employee, expenseCount : Integer}) : Boolean {
            		group.employee == salesGuy
        		}
        	);        	
            Assert#isNotNull(ceoStats);
            Assert#areEqual(3, ceoStats.expenseCount);            
            Assert#isNotNull(salesGuyStats);
            Assert#areEqual(1, salesGuyStats.expenseCount);            
        end;
    end;        
end;

end.