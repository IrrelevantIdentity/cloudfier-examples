package tests;

import car_rental;

[Test]
class MakeScenarios

    operation creation();
    begin
        var carMake;
        begin
            carMake := Examples#newMake();
        end;
        begin
            Assert#isNotNull(carMake);
            Assert#isNotNull(carMake.name);                                    
            Assert#areEqual("Fiat", carMake.name);                                                
        end;
    end;
end;


[Test]
class ModelScenarios

    operation creation();
    begin
        var carModel;
        begin
            carModel := Examples#newModel();
        end;
        begin
            Assert#isNotNull(carModel);
            Assert#isNotNull(carModel.name);            
            Assert#areEqual("Mille", carModel.name);                                                                        
            Assert#isNotNull(carModel.make);            
            Assert#isNotNull(carModel.make.name);                                    
            Assert#areEqual("Fiat", carModel.make.name);                                                            
        end;
    end;
end;


[Test]
class CustomerScenarios

    operation creation();
    begin
        var customer;
        begin
            customer := Examples#newCustomer();
        end;
        begin
            Assert#isNotNull(customer);
            Assert#isNotNull(customer.name);
            Assert#areEqual("Joana de Almeida", customer.name);                                                                        
        end;
    end;


    operation rentalHistory();
    begin
        var car, customer;
        begin
            car := Examples#newCar();
            customer := Examples#newCustomer();
            customer.rent(car);
            Assert#areEqual(1, customer.rentals.size());
            customer.finishRental();
        end;
        begin
            customer.rent(car);
            Assert#areEqual(2, customer.rentals.size());
        end;
    end;
end;

[Test]
class RentalScenarios

    operation startsAsInProgress();
    begin
        var car, customer;
        begin
            car := Examples#newCar();
            customer := Examples#newCustomer();
            Assert#isNull(customer.currentRental);
            customer.rent(car);
        end;
        begin
            Assert#isNotNull(customer.currentRental);
            Assert#isTrue(customer.currentRental.inProgress);
        end;
    end;

    operation finishedUponReturn();
    begin
        var car, customer, rental;
        begin
            car := Examples#newCar();
            customer := Examples#newCustomer();
            customer.rent(car);
            rental := customer.currentRental;
        end;
        begin
            Assert#isTrue(rental.inProgress);
            customer.finishRental();
        end;
        begin
            Assert#isTrue(not rental.inProgress);
        end;
    end;

    [Failure(constraint="customer_must_have_no_current_rental")]
    operation oneCarPerCustomer();
    begin
        var car1, car2, customer;
        begin
            car1 := Examples#newCar();
            customer := Examples#newCustomer();
            customer.rent(car1);
        end;
        begin
            car2 := Examples#newCar();
            customer.rent(car2);
        end;
    end;

    [Failure(constraint="car_must_be_available")]
    operation carUnavailable();
    begin
        var car, customer1, customer2;
        begin
            car := Examples#newCar();
            customer1 := Examples#newCustomer();
            customer1.rent(car);
        end;
        begin
            Assert#isTrue(car.rented);
            customer2 := Examples#newCustomer();
            customer2.rent(car);
        end;
    end;
end;

[Test]
class CarScenarios

    operation creation();
    begin
        var car;
        begin
            car := Examples#newCar();
        end;
        begin
            Assert#isNotNull(car);
            Assert#isNotNull(car.plate);            
            Assert#isNotNull(car.carModel);
            Assert#isNotNull(car.carModel.name);            
            Assert#isNotNull(car.carModel.make);                        
            Assert#isNotNull(car.carModel.make.name);                                    
        end;
    end;

    operation startsAsValid();
    begin
        var car;
        car := Examples#newCar();
    end;

    operation startsAsAvailable();
    begin
        var car;
        car := Examples#newCar();
        Assert#isTrue(car.available);
    end;

    [Failure(constraint="above_minimum", context="year")]
    operation tooOld();
    begin
        var car;
        car := Examples#newCar();
        car.year := 1900;
    end;

    [Failure(constraint="below_maximum", context="year")]
    operation tooNew();
    begin
        var car;
        car := Examples#newCar();
        car.year := 2500;
    end;

    [Failure(constraint="above_minimum", context="price")]
    operation priceIsTooLow();
    begin
        var car;
        car := Examples#newCar();
        car.price := 49;
    end;

    [Failure(constraint="below_maximum", context="price")]
    operation priceIsTooHigh();
    begin
        var car;
        car := Examples#newCar();
        car.price := 2000;
    end;

    operation unavailableWhenRented();
    begin
        var car, customer;
        begin
            car := Examples#newCar();
            customer := Examples#newCustomer();
            Assert#areEqual(Car::Status#Available, car.status);
            customer.rent(car);
        end;
        begin
            Assert#areEqual(Car::Status#Rented, car.status);
        end;
    end;
    
    operation availableUponReturn();
    begin
        var car, customer, rental;
        begin
            car := Examples#newCar();
            customer := Examples#newCustomer();
        end;
        begin
            Assert#isTrue(car.available);
            customer.rent(car);
            rental := customer.currentRental;
        end;
        begin
            Assert#isTrue(not car.available);
            customer.finishRental();
        end;
        begin
            Assert#isTrue(rental.car.available);
        end;
    end;

    operation unavailableWhenUnderRepair();
    begin
        var car;
        begin
            car := Examples#newCar();
            Assert#isTrue(car.available);        
            Assert#isTrue(not car.underRepair);
            car.startRepair();
        end;
        begin
            Assert#isTrue(not car.available);        
            Assert#isTrue(car.underRepair);
        end;
    end;
    
        
    operation availableUponRepairCompletion();
    begin
        var car;
        begin
            car := Examples#newCar();
            Assert#isTrue(car.available);
            car.startRepair();
        end;
        begin
            Assert#isTrue(not car.available);
            car.finishRepair();
        end;
        begin
            Assert#isTrue(car.available);
        end;
    end;
end;

class Examples

    private static operation newMake() : Make;
    begin
        var make;
        make := new Make;
        make.name := "Fiat";
        return make;
    end;

    private static operation newModel() : CarModel;
    begin
        var carModel;
        carModel := new CarModel;
        carModel.name := "Mille";
        carModel.make := Examples#newMake();
        return carModel;
    end;

    private static operation newCar() : Car;
    begin
        var car;
        car := new Car;
        car.year := Date#today().year();
        car.price := 100;
        car.color := "black";
        car.plate := "ABC-1234";
        car.carModel := Examples#newModel();
        return car;
    end;

    private static operation newCustomer() : Customer;
    begin
        var customer;
        customer := new Customer;
        customer.name := "Joana de Almeida";
        return customer;
    end;
end;

end.