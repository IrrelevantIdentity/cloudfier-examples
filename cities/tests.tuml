package cities_tests;

apply mdd_extensions;
import mdd_types;

import cities::State;
import cities;

[Test]
class Tests

    operation stateByAbbreviation();
    begin
        TestData#build();
        Assert#isNotNull(State#byAbbreviation("OR"));
        Assert#isNull(State#byAbbreviation("ZZ"));
    end;

    operation cityByName();
    begin
        var california;
        TestData#build();
        california := State#byAbbreviation("CA");
        Assert#isNotNull(california.city("San Francisco"));
        Assert#isNull(california.city("FooBar"));
    end;

    operation statePopulation();
    begin
        var oregon, expected;
        TestData#build();
        oregon := State#byAbbreviation("OR");
        Assert#isTrue(oregon.population > 0);
        expected := oregon.city("Portland").population + oregon.city("Eugene").population;
        Assert#areEqual(expected, oregon.population);
    end; 

    operation populousStates_Abbreviations();
    begin
        var populousStateAbbreviations;
        TestData#build();
        populousStateAbbreviations := State#abbreviationsOfStatesMorePopulousThan(500000);
        Assert#areEqual(2, populousStateAbbreviations.size());
        Assert#isTrue(populousStateAbbreviations.includes("CA"));
        Assert#isTrue(populousStateAbbreviations.includes("OR"));
        Assert#isTrue(! populousStateAbbreviations.includes("WY"));
    end;
    
    operation populousStates();
    begin
        var populousStates;
        TestData#build();
        populousStates := State#statesMorePopulousThan(500000);
        Assert#areEqual(2, populousStates.size());
        Assert#isTrue(populousStates.includes(State#byAbbreviation("CA")));        
        Assert#isTrue(populousStates.includes(State#byAbbreviation("OR")));
        Assert#isTrue(!populousStates.includes(State#byAbbreviation("WY")));
    end;
    
    
    static operation statsFinder(abbreviation : String) : {(: StatePopulation) : Boolean};
    begin
        return (stat : StatePopulation) : Boolean { stat.abbreviation == abbreviation };
    end;
    
    operation statePopulations();
    begin
        var populations, oregon, wyoming;
        TestData#build();
        oregon := State#byAbbreviation("OR");
        wyoming := State#byAbbreviation("WY");
        populations := State#statePopulations();
        Assert#areEqual(State extent.size(), populations.size());
        Assert#areEqual(wyoming.population, populations.\any((stat : StatePopulation) : Boolean { stat.abbreviation = "WY" }).population);
        Assert#areEqual(oregon.population, populations.\any((stat : StatePopulation) : Boolean { stat.abbreviation = "OR" }).population);
    end;
end;

class TestData

    static operation build();
    begin
        var california, oregon, wyoming;
        california := TestData#newState("California", "CA");
        TestData#newCity("San Francisco", 837442, california);
        TestData#newCity("San Mateo", 101128, california);
        TestData#newCity("San Diego", 1356000, california);
        oregon := TestData#newState("Oregon", "OR");
        TestData#newCity("Portland", 609456, oregon);
        TestData#newCity("Eugene", 159190, oregon);
        wyoming := TestData#newState("Wyoming", "WY");
        TestData#newCity("Cheyenne", 62448, wyoming);
    end;

    static operation newCity(name : String, population : Integer, cityState : State) : City;
    begin
        var city;
        city := new City;
        city.name := name;
        city.population := population;
        city.cityState := cityState;
        return city;
    end;

    static operation newState(name : String, abbreviation : String) : State;
    begin
        var newState;
        newState := new State;
        newState.name := name;
        newState.abbreviation := abbreviation;
        return newState;
    end;
end;

end.