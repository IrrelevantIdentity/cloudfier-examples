package tests;

import timetracker;


[Test]
class ClientScenarios
    operation clientsWithInvoicesToIssue();
    begin
        var client1, client2, client3, client4, client1Invoice, client2Invoice, client3Invoice;
        begin
            client1 := Examples#client();
            client2 := Examples#client();
            client3 := Examples#client();            
            client4 := Examples#client();                        
            client1Invoice := client1.startInvoice();
            client2Invoice := client2.startInvoice();            
            client3Invoice := client3.startInvoice();                        
            client1.newTask("Some task").addWork(1).submit(client1Invoice);
            client2.newTask("Some task").addWork(1).submit(client2Invoice);
            client3.newTask("Some task").addWork(1).submit(client3Invoice);            
            client3Invoice.issue();
        end;
        begin
            var clientsWithInvoicesToIssue;
            clientsWithInvoicesToIssue := Client#withInvoicesToIssue(); 
            Assert#areEqual(1, Client#withInvoicesIssued().size());            
            Assert#isTrue(2 <= clientsWithInvoicesToIssue.size());
            Assert#isTrue(clientsWithInvoicesToIssue.includes(client1));
            Assert#isTrue(clientsWithInvoicesToIssue.includes(client2));            
            Assert#isTrue(!clientsWithInvoicesToIssue.includes(client3));
            Assert#isTrue(!clientsWithInvoicesToIssue.includes(client4));            
        end;
    end;
end;

[Test]
class TaskScenarios

    operation timeReported();
    begin
        var task;
        task := Examples#task();
        task.addWork(4);
        task.addWork(3);
        Assert#areEqual(7, task.unitsReported);
    end;
    
    operation itemsReported();
    begin
        var task;
        task := Examples#task();
        task.addWork(4);
        task.addWork(3);   
        Assert#areEqual(2, task.reported.size());

        task.addWork(5);
        Assert#areEqual(3, task.reported.size());
    end; 

    operation timeToInvoice();
    begin
        var task, invoice, work1, work2;
        task := Examples#task();
        work1 := task.addWork(4);
        work2 := task.addWork(3);
        invoice := task.client.startInvoice();
        work1.submit(invoice);
        Assert#areEqual(1, task.toInvoice.size());
        Assert#areEqual(3, task.unitsToInvoice);
    end;
end;

[Test] 
class WorkScenarios

    operation workDateDefaultsToToday();
    begin
        var work;
        work := Examples#task().addWork(1); 
        Assert#areEqual(Date#today(), work.date);
    end;

    [Failure(constraint="WrongClient", context="submit")]
    operation cannotAssignWorkToInvoiceFromAnotherClient();
    begin
        var client1, client2, work;
        client1 := Examples#client();
        client2 := Examples#client();
        work := client1.newTask("Some task").addWork(1);
        work.submit(client2.startInvoice());
    end;

    [Failure(constraint="AlreadyInvoiced", context="submit")]
    operation cannotSubmitWorkToInvoiceAlreadyInvoiced();
    begin
        var invoice, work;
        work := Examples#client().newTask("Some task").addWork(1);
        invoice := work.client.startInvoice();
        work.submit(invoice);
        work.submit(invoice);
    end;

    [Failure(constraint="MustBePositive", context="units")]
    operation unitsWorkedMustBePositive();
    begin
        Examples#task().addWork(- 1);
    end;

    [Failure(constraint="MustBePositive", context="units")]
    operation unitsWorkedMayNotBeZero();
    begin
        Examples#task().addWork(0);
    end;
end;

[Test]
class InvoiceScenarios

    operation issueInvoice();
    begin
        var invoice, work, client;
        begin
            client := Examples#client();
            work := client.newTask("Some task").addWork(1);
            invoice := client.startInvoice();
            work.submit(invoice);
            Assert#areEqual(Invoice::Status#Preparation, invoice.status);
            invoice.issue();
        end;
        begin
            Assert#areEqual(Invoice::Status#Invoiced, invoice.status);
        end;
    end;
    
    operation totalUnits();
    begin
        var invoice, task1, task2, client;
        begin
            client := Examples#client();
            invoice := client.startInvoice();
            task1 := client.newTask("Task 1");
            task2 := client.newTask("Task 2");
            task1.addWork(1).submit(invoice);
            task1.addWork(3).submit(invoice);
            task2.addWork(7).submit(invoice);            
        end;
        begin
            Assert#areEqual(11, invoice.totalUnits);
        end;
    end;    
    
    operation invoicePaid();
    begin
        var invoice;
        begin
            invoice := Examples#client().startInvoice();
            invoice.client.newTask("Some task").addWork(1).submit(invoice);
            invoice.issue();
            send InvoicePaid() to invoice;
        end;
        begin
            Assert#areEqual(Invoice::Status#Received, invoice.status);
        end;
    end;

    [Failure(constraint="InvoiceNotOpen", context="submit")]
    operation cannotSubmitWorkIfInvoiceNotOpen();
    begin
        var task, invoice;
        begin
            task := Examples#task();
            invoice := task.client.startInvoice();
            task.addWork(1).submit(invoice);
            invoice.issue();
        end;
        begin
            task.addWork(2).submit(invoice);
        end;
    end;

    [Failure(constraint="MustHaveWork", context="issue")]
    operation cannotIssueInvoiceWithoutAnyWork();
    begin
        Examples#client().startInvoice().issue();
    end;
end;

class Examples

    private static operation clientWithName(name : String) : Client;
    begin
        var client;
        client := new Client;
        client.name := name;
        return client;
    end;

    private static operation client() : Client;
    begin
        return Examples#clientWithName("New Client");
    end;

    private static operation taskWithName(description : String, client : Client) : Task;
    begin
        var task;
        task := new Task;
        task.description := description;
        task.client := client;
        return task;
    end;

    private static operation task() : Task;
    begin
        return Examples#taskWithName("New Task", Examples#client());
    end;
end;

end.
